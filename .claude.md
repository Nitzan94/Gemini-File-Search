# Gemini File Search - Managed RAG System

## Architecture

FastAPI backend + vanilla JS/HTMX frontend using Google Gemini File Search API.

**Core flow:**
1. Upload file → tempfile → Gemini SDK → Operation (async processing)
2. Poll operation status → STATE_PENDING → STATE_ACTIVE (30-60s)
3. Query → Gemini file search → AI response + citations

## Key Files

- `main.py` - FastAPI app entry, router setup
- `api/client.py` - GeminiClient singleton wrapper
- `api/stores.py` - Store CRUD routes
- `api/documents.py` - Upload (tempfile pattern), list, delete, operation polling
- `api/query.py` - Semantic search with citation extraction
- `templates/store_detail.html` - Store page: upload, chat, document list

## Critical Patterns

**Tempfile Upload:**
```python
with tempfile.NamedTemporaryFile(delete=False, suffix=ext) as tmp:
    tmp.write(content)
    tmp_path = tmp.name
operation = client.upload_document(tmp_path, ...)
os.unlink(tmp_path)  # Always cleanup
```

**Safe Citation Extraction:**
Always use `hasattr()` - SDK response structure varies.

**Operation Polling:**
Frontend polls every 2s until `operation.done == True`, then refreshes doc list.

## Document States

- `STATE_PENDING` - Processing (chunking, embedding, indexing)
- `STATE_ACTIVE` - Ready for search
- `STATE_FAILED` - Processing error

## Store Page UI

`/stores/{store_id}` → `store_detail.html`:
1. Store info card (doc counts, storage size)
2. Upload zone (drag-drop)
3. Chat interface (query with citations)
4. Documents list (state badges, delete buttons)

## API Endpoints

- `POST /api/stores` - Create store
- `GET /api/stores/{id}` - Get store with metrics
- `POST /api/stores/{id}/upload` - Upload file
- `GET /api/stores/{id}/documents` - List documents
- `DELETE /api/stores/{id}/documents/{doc_id}` - Delete document
- `GET /api/stores/operations/{op_id}` - Poll operation status
- `POST /api/query` - Semantic search

## Name Formats

- Store: `fileSearchStores/{store_id}`
- Document: `fileSearchStores/{store_id}/documents/{doc_id}`
- Operation: `fileSearchStores/{store_id}/upload/operations/{op_id}`

## Tech Stack

- **Backend:** FastAPI, google-genai SDK, Jinja2
- **Frontend:** HTMX 1.9.10, vanilla JS
- **Package:** uv (always `uv run`, never `python`)
- **Managed by Google:** Chunking, embedding (text-embedding-004), vector DB

## Common Issues

**Documents not showing:**
- Check operation polling is working (see browser console)
- Verify HTMX trigger fires on `documentUploaded` event
- Ensure `/api/stores/{id}/documents` endpoint returns correctly
- Check document state - PENDING docs still processing
